name: Compilar, Testar e Enviar para ECR
on:
    push:
        branches:
            - main
    pull_request:
        types: [opened, synchronize, reopened]
    workflow_dispatch:

jobs:
    build-and-push:
        runs-on: ubuntu-latest
        env:
            ECR_REPO_NAME: 'fiap-webapi'
            IMAGE_TAG: 'latest'
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                # Desabilitar clone superficial é recomendado para melhorar a relevância da análise do Sonar.
                fetch-depth: 0

            - name: Set up .NET
              uses: actions/setup-dotnet@v4
              with:
                dotnet-version: '8.0.x'

            # A análise Sonar requer o JDK.
            - name: Set up JDK 17
              uses: actions/setup-java@v4
              with:
                java-version: '17'
                distribution: 'temurin'

            # Etapa para cachear as dependências do SonarScanner e acelerar builds futuros.
            - name: Cache SonarQube packages
              uses: actions/cache@v4
              with:
                path: ~/.sonar/cache
                key: ${{ runner.os }}-sonar
                restore-keys: ${{ runner.os }}-sonar

            # Instala o SonarScanner para .NET.
            - name: Install SonarScanner for .NET
              run: dotnet tool install --global dotnet-sonarscanner

            # Inicia a análise do Sonar. Captura as métricas antes da compilação.
            - name: Begin SonarQube Scan
              run: |
                dotnet sonarscanner begin /k:"seu-project-key" \
                  /o:"sua-organizacao" \
                  /d:sonar.login="${{ secrets.SONAR_TOKEN }}" \
                  /d:sonar.host.url="https://sonarcloud.io" \
                  /d:sonar.cs.opencover.reportsPaths=coverage.opencover.xml

            # Restaura as dependências do projeto.
            - name: Restore dependencies
              run: dotnet restore

            # Compila o projeto. Esta etapa é necessária para a análise do Sonar.
            - name: Build project
              run: dotnet build --no-restore

            # Executa os testes e gera o relatório de cobertura.
            - name: Run tests and collect coverage
              run: dotnet test --collect:"XPlat Code Coverage" --results-directory "TestResults"

            # Finaliza a análise e envia os dados para o SonarCloud.
            - name: End SonarQube Scan
              run: dotnet sonarscanner end /d:sonar.login="${{ secrets.SONAR_TOKEN }}"

            # A partir daqui, as etapas de deploy para AWS continuam as mesmas.
            - name: Configure AWS credentials
              uses: aws-actions/configure-aws-credentials@v4
              with:
                aws-access-key-id: ${{ vars.AWS_ACCESS_KEY_ID }}
                aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
                aws-region: ${{ vars.AWS_REGION }}

            - name: Log in to Amazon ECR
              uses: aws-actions/amazon-ecr-login@v2

            - name: Create ECR repository if not exists
              run: |
                aws ecr describe-repositories --repository-names ${{ env.ECR_REPO_NAME }} || \
                aws ecr create-repository --repository-name ${{ env.ECR_REPO_NAME }}
                
            - name: Build and push Docker image to ECR
              uses: docker/build-push-action@v5
              with:
                context: ./
                file: ./Dockerfile
                push: true
                tags: ${{ vars.AWS_ACCOUNT_ID }}.dkr.ecr.${{ vars.AWS_REGION }}.amazonaws.com/${{ env.ECR_REPO_NAME }}:${{ env.IMAGE_TAG }}
